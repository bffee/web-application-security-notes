# Weaknesses in Token Generation

Session management vulnerabilities often originate from **predictable or structured token generation**, allowing attackers to guess or derive other users' session tokens.

---

## Scope Beyond Session Tokens

These considerations apply to many security-critical tokens, including:

- **Password reset** tokens (via email)
- **CSRF protection** tokens (see Chapter 13)
- **One-time access** links
- **"Remember me"** persistent login tokens
- **Order tracking** links in unauthenticated shopping carts

In modern applications, the **most exploitable weaknesses** are often found in these auxiliary tokens rather than standard session cookies (which are usually generated by hardened platform APIs).

---

## 1. Meaningful Tokens

Some applications use tokens that **encode identifiable information**. Even if they appear random, decoding may reveal structure or data such as:

- Username
- Account number
- Email address
- Role/group (e.g., `admin`)
- Date/time
- IP address
- Predictable/incremental values

### Example

A token like:

```
757365723d6461663b6170703d61646d696e3b646174653d30312f31322f3131
```

…when hex-decoded becomes:

```
user=daf;app=admin;date=01/12/11
```

Such tokens allow attackers to generate plausible guesses for other users’ tokens.

---

## 2. Structured Tokens

Tokens with internal **delimiters** or fixed fields often indicate structured content:

- Fields may be **independently encoded** (Base64, hex, XOR)
- Applications may only validate **specific components**, reducing effective entropy

Attackers can:

- Decode and isolate components
- Identify which parts are actually validated
- Generate valid tokens with brute force or semi-automated guessing

---

## HACK STEPS

1. **Identify critical parts of the token**
   - Modify one byte/bit at a time using **Burp Intruder’s char frobber**.
   - Observe whether changes are accepted—non-essential parts can be ignored.

2. **Gather token samples**
   - Log in as multiple users with controlled variations:
     - Usernames like `A`, `AA`, `AAA`, `AAAA`, `AAAB`, etc.
     - Vary other attributes like email.
   - Record issued session tokens.

3. **Analyze correlations**
   - Look for token sections that correlate with input (username, email, etc.)

4. **Check for encodings**
   - **XOR patterns** (look for repeating sequences)
   - **Hexadecimal-only** values: decode to ASCII
   - **Base64** clues:
     - Ends with `=`
     - Uses only `A–Z`, `a–z`, `0–9`, `+`, `/`

5. **Token guessing attack**
   - Reverse-engineer token format and guess valid tokens.
   - Target session-dependent pages (e.g., user profile or dashboard).
   - Use **Burp Intruder** to automate testing.
   - Detect successful guesses via changes in HTTP responses (status codes, redirects, etc.).

---

## Summary Table

| Token Type       | Common Issue                     | Risk Level             |
|------------------|----------------------------------|------------------------|
| Session Token    | Predictable / Structured format  | Full session hijack    |
| Password Reset   | Weak entropy / encodable data    | Account takeover       |
| CSRF Token       | Reusable / guessable             | Authenticated actions  |
| Remember Me      | Tied to username, no expiry      | Persistent compromise  |

